---
config:
  layout: dagre
---
flowchart TD
    %% 用戶充電流程
    A["🚗 用戶開始充電"] --> B["📝 charging_transactions<br/>記錄充電過程"]
    B --> C["💰 billing_records<br/>計算費用"]
    
    %% 支付方式選擇
    C --> D{"💳 選擇支付方式"}
    
    %% RFID 支付流程
    D -->|RFID 卡|E["🔍 驗證 rfid_cards<br/>檢查卡片狀態"]
    E --> F["💰 檢查 user_wallets<br/>餘額是否足夠"]
    F --> G["📊 wallet_transactions<br/>記錄扣款交易"]
    G --> H["✅ 更新 billing_records<br/>付款狀態為 PAID"]
    
    %% 第三方支付流程 - 支援儲值和即時支付
    D -->|第三方支付|I{"🎯 支付類型"}
    
    %% 即時支付分支
    I -->|即時支付|J["🔗 第三方 API<br/>直接扣款"]
    J --> K["📝 wallet_transactions<br/>記錄 PAYMENT 交易<br/>(不經錢包)"]
    K --> L["✅ 更新 billing_records<br/>付款狀態為 PAID"]
    
    %% 儲值分支
    I -->|儲值|M["💵 第三方 API<br/>儲值到錢包"]
    M --> N["📊 wallet_transactions<br/>記錄 DEPOSIT 交易"]
    N --> O["💰 更新 user_wallets<br/>增加餘額"]
    O --> P["✅ 儲值完成<br/>可用於後續支付"]
    
    %% 獨立儲值流程
    Q["💳 用戶主動儲值"] --> R["🔗 第三方 API<br/>處理儲值請求"]
    R --> S["📊 wallet_transactions<br/>記錄 DEPOSIT 交易"]
    S --> T["💰 更新 user_wallets<br/>增加餘額"]
    
    %% 樣式定義
    classDef process fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef database fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef success fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    
    class A,B,C,E,F,G,H,J,K,L,M,N,O,P,R,S,T process
    class D,I decision
    class Q database
    class Q success
