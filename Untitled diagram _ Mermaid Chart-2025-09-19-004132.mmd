---
config:
  layout: dagre
---
flowchart TD
    %% ç”¨æˆ¶å……é›»æµç¨‹
    A["ğŸš— ç”¨æˆ¶é–‹å§‹å……é›»"] --> B["ğŸ“ charging_transactions<br/>è¨˜éŒ„å……é›»éç¨‹"]
    B --> C["ğŸ’° billing_records<br/>è¨ˆç®—è²»ç”¨"]
    
    %% æ”¯ä»˜æ–¹å¼é¸æ“‡
    C --> D{"ğŸ’³ é¸æ“‡æ”¯ä»˜æ–¹å¼"}
    
    %% RFID æ”¯ä»˜æµç¨‹
    D -->|RFID å¡|E["ğŸ” é©—è­‰ rfid_cards<br/>æª¢æŸ¥å¡ç‰‡ç‹€æ…‹"]
    E --> F["ğŸ’° æª¢æŸ¥ user_wallets<br/>é¤˜é¡æ˜¯å¦è¶³å¤ "]
    F --> G["ğŸ“Š wallet_transactions<br/>è¨˜éŒ„æ‰£æ¬¾äº¤æ˜“"]
    G --> H["âœ… æ›´æ–° billing_records<br/>ä»˜æ¬¾ç‹€æ…‹ç‚º PAID"]
    
    %% ç¬¬ä¸‰æ–¹æ”¯ä»˜æµç¨‹ - æ”¯æ´å„²å€¼å’Œå³æ™‚æ”¯ä»˜
    D -->|ç¬¬ä¸‰æ–¹æ”¯ä»˜|I{"ğŸ¯ æ”¯ä»˜é¡å‹"}
    
    %% å³æ™‚æ”¯ä»˜åˆ†æ”¯
    I -->|å³æ™‚æ”¯ä»˜|J["ğŸ”— ç¬¬ä¸‰æ–¹ API<br/>ç›´æ¥æ‰£æ¬¾"]
    J --> K["ğŸ“ wallet_transactions<br/>è¨˜éŒ„ PAYMENT äº¤æ˜“<br/>(ä¸ç¶“éŒ¢åŒ…)"]
    K --> L["âœ… æ›´æ–° billing_records<br/>ä»˜æ¬¾ç‹€æ…‹ç‚º PAID"]
    
    %% å„²å€¼åˆ†æ”¯
    I -->|å„²å€¼|M["ğŸ’µ ç¬¬ä¸‰æ–¹ API<br/>å„²å€¼åˆ°éŒ¢åŒ…"]
    M --> N["ğŸ“Š wallet_transactions<br/>è¨˜éŒ„ DEPOSIT äº¤æ˜“"]
    N --> O["ğŸ’° æ›´æ–° user_wallets<br/>å¢åŠ é¤˜é¡"]
    O --> P["âœ… å„²å€¼å®Œæˆ<br/>å¯ç”¨æ–¼å¾ŒçºŒæ”¯ä»˜"]
    
    %% ç¨ç«‹å„²å€¼æµç¨‹
    Q["ğŸ’³ ç”¨æˆ¶ä¸»å‹•å„²å€¼"] --> R["ğŸ”— ç¬¬ä¸‰æ–¹ API<br/>è™•ç†å„²å€¼è«‹æ±‚"]
    R --> S["ğŸ“Š wallet_transactions<br/>è¨˜éŒ„ DEPOSIT äº¤æ˜“"]
    S --> T["ğŸ’° æ›´æ–° user_wallets<br/>å¢åŠ é¤˜é¡"]
    
    %% æ¨£å¼å®šç¾©
    classDef process fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef database fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef success fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    
    class A,B,C,E,F,G,H,J,K,L,M,N,O,P,R,S,T process
    class D,I decision
    class Q database
    class Q success
