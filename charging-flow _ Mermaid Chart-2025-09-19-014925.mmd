---
config:
  layout: elk
  look: neo
  theme: neo
---
flowchart TD
    A(["開始充電請求"]) --> B{"用戶身份驗證"}
    B -- RFID 卡 --> C[驗證 rfid_cards 身份]
    C --> D[取得用戶 user_id]
    B -- Vehicle ID --> D
    D --> E[檢查 user_wallets 餘額]
    E --> F{餘額是否足夠?}
    F -- 足夠 --> G[記錄 charging_transactions]
    G --> H[計算 billing_records]
    H --> I[記錄 wallet_transactions 扣款]
    I --> J([更新 billing_records 為 PAID])
    F -- 不足 --> K[提示用戶儲值]
    K --> L(["充電請求拒絕"])

    M(["用戶主動儲值"]) --> N{儲值方式}
    N -- 手動儲值 --> O[管理員手動增加餘額]
    O --> Q[記錄 wallet_transactions DEPOSIT]
    N -- 第三方支付 --> R[第三方 API 處理儲值]
    R --> Q
    Q --> S[更新 user_wallets 增加餘額]
    S --> T([儲值完成，可用於支付])

    classDef process fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef database fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef terminator fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef warning fill:#ffebee,stroke:#c62828,stroke-width:2px

    class C,D,E,G,H,I,O,R process
    class B,F,N decision
    class J,L,T terminator
    class K warning
